function Emitter(t){if(t)return mixin(t)}function mixin(t){for(let e in Emitter.prototype)t[e]=Emitter.prototype[e];return t._callbacks={},t}"undefined"!=typeof module&&(module.exports=Emitter),Emitter.prototype.on=Emitter.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},Emitter.prototype.once=function(t,e){function i(){this.off(t,i),e.apply(this,arguments)}return i.fn=e,this.on(t,i),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;let i,r=this._callbacks["$"+t];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(let t=0;t<r.length;t++)if(i=r[t],i===e||i.fn===e){r.splice(t,1);break}return 0===r.length&&delete this._callbacks["$"+t],this},Emitter.prototype.emit=function(t){this._callbacks=this._callbacks||{};let e=[].slice.call(arguments,1),i=this._callbacks["$"+t];if(i){i=i.slice(0);for(let t=0,r=i.length;t<r;++t)i[t].apply(this,e)}return this},Emitter.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},Emitter.prototype.hasListeners=function(t){return!!this.listeners(t).length};
function hex2ab(r){let t=[];for(let n=0;n<r.length;n+=2)t.push(parseInt("0x"+r.substr(n,2),16));return t}function str2ab(r){let t=new ArrayBuffer(r.length),n=new Uint8Array(t);for(let t=0,e=r.length;t<e;t++)n[t]=r.charCodeAt(t);return t}function buf2hex(r){return Array.prototype.map.call(new Uint8Array(r),r=>("00"+r.toString(16)).slice(-2)).join("")}function stringFromUTF8Array(r){const t=[1,1,1,1,2,2,3,0];let n=r.length,e="";for(let l=0;l<n;){let o=r[l++];if(128&o){let e=t[o>>3&7];if(!(64&o)||!e||l+e>n)return null;for(o&=63>>e;e>0;e-=1){let t=r[l++];if(128!=(192&t))return null;o=o<<6|63&t}}e+=String.fromCharCode(o)}return e}
class Streams{static isAvailable(){return"undefined"!=typeof CompressionStream}static async compress(e,r="gzip"){let t=(new TextEncoder).encode(e),s=new CompressionStream(r),a=s.writable.getWriter();return a.write(t),a.close(),new Response(s.readable).arrayBuffer()}static async decompress(e,r="gzip"){let t=new DecompressionStream(r),s=t.writable.getWriter();s.write(e),s.close();let a=await new Response(t.readable).arrayBuffer();return(new TextDecoder).decode(a)}}
"undefined"!=typeof module&&(module.exports=Security),Security=(()=>{var n=null,e=null,t=null;const r=new TextEncoder;async function i(n,e,t){let r=window.atob(n),i=str2ab(r);return window.crypto.subtle.importKey("spki",i,e,!0,[t])}const o={isAvailable:function(){return null!=window.crypto.subtle},isActive:function(){return null!==n&&null!==e},init:function(o){return async function(o){if(!window.crypto.subtle)return void console.log("Security mode not available, TLS protocol required.");console.log("Security Initializing..."),n=await i(o.keyEnc,{name:"RSA-OAEP",hash:"SHA-256"},"encrypt"),e=await async function(){return window.crypto.subtle.generateKey({name:"AES-CTR",length:128},!0,["encrypt","decrypt"])}(),t=await async function(n){let e=await window.crypto.subtle.exportKey("raw",n);return new Uint8Array(e)}(e);let a=await i(o.keyVer,{name:"ECDSA",namedCurve:"P-384"},"verify");if(!await async function(n,e,t){let i=str2ab(atob(e)),o=r.encode(t);return window.crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-384"}},n,i,o)}(a,o.signature,function(n){return[n.challenge||"",n.keyEnc||"",n.keyVer||""].join("")}(o||{})))throw n=null,e=null,t=null,new Error("Signature invalid");console.log("Security Initialized!")}(o)},encrypt:function(i,o){return async function(i,o){let a=function(n){let e=new Uint8Array(16);return window.crypto.getRandomValues(e),e}(),u=new Uint8Array(a.length+t.length);u.set(a),u.set(t,a.length);let c=await async function(e){let t=e;return"string"==typeof e&&(t=r.encode(e)),window.crypto.subtle.encrypt("RSA-OAEP",n,t)}(u),l=await async function(n,e,t){let i=r.encode(t),o={name:"AES-CTR",counter:e,length:128};return window.crypto.subtle.encrypt(o,n,i)}(e,a,i);return!0===o?{d:l,k:c}:{d:buf2hex(l),k:buf2hex(c)}}(i,o)},decrypt:function(n){return async function(n){let t=n.iv,r=n.d,i=await async function(n,e,t){let r=hex2ab(t),i=hex2ab(e),o=new Uint8Array(i),a=new Uint8Array(r),u={name:"AES-CTR",counter:o,length:128};return window.crypto.subtle.decrypt(u,n,a)}(e,t,r);var o=stringFromUTF8Array(new Uint8Array(i)),a=JSON.parse(o);return a&&"ws"==a.type&&"data"===a.cmd&&(a=a.data),a}(n)}};return Object.freeze(o),o})();
"undefined"!=typeof module&&(module.exports=Generator),Generator=(()=>{function e(e){var r,a,c,o=null;a=e.namespace,c=null,a.split(".").every(e=>(c?(c[e]||(c[e]={}),Object.freeze(c),c=c[e]):(window[e]||(window[e]={}),c=window[e]),!0)),(o=c)[e.action]||(o[e.action]={}),r=o[e.action],e.methods.every(a=>(function(e,r,a,c){let o=!1!==c.encrypt,i={n:e,c:r,m:c.name,l:c.len,e:o};var l;a[c.name]=(l=i,function(){let e,r,a=null;return e=Array.prototype.slice.call(arguments),r={namespace:l.n,action:l.c,method:l.m,e:l.e,data:e},a=new Promise((e,a)=>{t.emit("call",r,(t,r)=>{n(t,r,l,e,a)})}),a}),Object.freeze(a[c.name])}(e.namespace,e.action,r,a),!0))}function n(e,n,t,r,a){e?a(e):t.c===n.action&&t.m===n.method&&n.result&&n.result.success?r(n.result):a(n.result||n)}var t={build:function(n){return async function(n){let t=n.api||n;var r;return r=t,Array.isArray(r)?r.every(n=>(e(n),!0)):e(r),t}(n)}};return Emitter(t),Object.freeze(t),t})();
"undefined"!=typeof module&&(module.exports=WebChannel),WebChannel=(()=>{const t="application/json",e={Accept:t,"Content-Type":t};var n={init:function(t){return function(t){Generator.off("call"),Generator.on("call",async(n,r)=>{try{r(null,await async function(t,n){let r=Array.isArray(n.data)&&n.data.length>0,a=n;if(Security.isActive()&&r&&(a=await Security.encrypt(JSON.stringify(n))),a=await async function(t,n){let r=JSON.stringify(n),a={method:"post",heaedrs:e,body:r},c=await fetch(t,a);return await c.json()}(t,a),"err"==a.cmd)throw new Error(a.result.msg);return"enc"===a.cmd&&(a=await Security.decrypt(a)),a}(t,n))}catch(t){r(t,null)}})}(t)}};return Object.freeze(n),n})();
"undefined"!=typeof module&&(module.exports=SocketChannel),SocketChannel=(()=>{new TextDecoder,new TextEncoder;var e=0,n={up:0,down:0},t=null;async function r(e){let n=null;try{if(e instanceof ArrayBuffer){let t=await Streams.decompress(e);n=JSON.parse(t)}"string"==typeof e&&(n=JSON.parse(e)),n?async function(e){let n=null;"api"===e.cmd?Generator.emit("api",e.data):"err"===e.cmd?Generator.emit("error",e.result):"data"===e.cmd?a(e=e.data):"enc"===e.cmd&&(n=await Security.decrypt(e),n)?a(n):Engine.emit("message",e)}(n):Generator.emit("error",event)}catch(e){Generator.emit("error",e)}}function a(e){Array.isArray(e)?e.every(e=>(i(e),!0)):i(e)}function i(e){if(n.down++,"function"==typeof n[e.tid])try{n[e.tid](null,e)}finally{n[e.tid]=null}else Engine.emit("message",e);n.up>50&&n.down>=n.up&&(n={up:0,down:0})}function o(r,a){(async function(r,a){let i=null,o=null,l=null,c="data",u=function(e){let n=Array.isArray(e.data)&&e.data.length>0&&!1!==e.e;return Security.isActive()&&n}(r);if(function(t,r){e++,t.tid=e.toString(),n[t.tid]=r,n.up++}(r,a),u&&(o=await Security.encrypt(JSON.stringify(r.data)),r.data=[o],c="enc"),l={cmd:c,type:"ws",data:[r]},i=JSON.stringify(l),!Streams.isAvailable())return t.send(i);i=await Streams.compress(i),t.send(i)})(r,a).catch(e=>{a(e,null)})}function l(){null!==t&&(t.close(),t=null)}var c={init:function(e,n){return function(e,n){return l(),new Promise((n,a)=>(async function(e,n,a,i){(t=new WebSocket(e,["ws4is"])).binaryType="arraybuffer",t.onopen=function(e){Generator.on("call",o),a(!0)},t.onclose=function(e){Generator.off("call",o),t=null,Engine.emit("offline")},t.onerror=function(e){Generator.off("call",o),i(e),Generator.emit("error",e),t=null},t.onmessage=function(e){r(e.data)}}(e,0,n,a),null))}(e)},kill:function(){return l()}};return Object.freeze(c),c})();
"undefined"!=typeof module&&(module.exports=Engine),Engine=(()=>{async function e(e){e.signature&&(Security.isActive()||await Security.init(e)),Generator.build(e.api)}var n={init:function(n){return async function(n){if(!(n=n||{}).api)throw new Error("API Url not defined!");if(Generator.off("call"),SocketChannel&&SocketChannel.kill(),n.api===n.service&&0==n.api.indexOf("ws"))return await function(n){return new Promise((i,t)=>{var a=Date.now();return Generator.once("api",async n=>{n.challenge=a;try{await e(n),i(!0)}catch(e){t(e)}}),SocketChannel.init(n.service+"?q="+a,n.wasm),null})}(n);if(await async function(n){let i=await async function(e){let n=location.pathname.split("/")[1],i=e||location.origin+`/${n}/api`,t=Date.now(),a=await fetch(i,{method:"get",headers:{"x-time":t}}),r=await a.json();return r.challenge=t.toString(),r}(n.api);await e(i)}(n),await async function(e){return!!e.service&&(0===e.service.indexOf("http")?(await WebChannel.init(e.service),!0):0===e.service.indexOf("ws")&&(await SocketChannel.init(e.service,e.wasm),!0))}(n))return!0;throw new Error("Invalid definition for Engine Remote Service")}(n)}};return Emitter(n),Object.freeze(n),n})();