function Emitter(t){if(t)return mixin(t)}function mixin(t){for(let e in Emitter.prototype)t[e]=Emitter.prototype[e];return t._callbacks={},t}"undefined"!=typeof module&&(module.exports=Emitter),Emitter.prototype.on=Emitter.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},Emitter.prototype.once=function(t,e){function i(){this.off(t,i),e.apply(this,arguments)}return i.fn=e,this.on(t,i),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;let i,r=this._callbacks["$"+t];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(let t=0;t<r.length;t++)if(i=r[t],i===e||i.fn===e){r.splice(t,1);break}return 0===r.length&&delete this._callbacks["$"+t],this},Emitter.prototype.emit=function(t){this._callbacks=this._callbacks||{};let e=[].slice.call(arguments,1),i=this._callbacks["$"+t];if(i){i=i.slice(0);for(let t=0,r=i.length;t<r;++t)i[t].apply(this,e)}return this},Emitter.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},Emitter.prototype.hasListeners=function(t){return!!this.listeners(t).length};
function hex2ab(r){let t=[];for(var n=0;n<r.length;n+=2)t.push(parseInt("0x"+r.substr(n,2),16));return t}function str2ab(r){let t=new ArrayBuffer(r.length),n=new Uint8Array(t);for(let t=0,e=r.length;t<e;t++)n[t]=r.charCodeAt(t);return t}function buf2hex(r){return Array.prototype.map.call(new Uint8Array(r),r=>("00"+r.toString(16)).slice(-2)).join("")}function stringFromUTF8Array(r){const t=[1,1,1,1,2,2,3,0];let n=r.length,e="";for(let l=0;l<n;){let o=r[l++];if(128&o){let e=t[o>>3&7];if(!(64&o)||!e||l+e>n)return null;for(o&=63>>e;e>0;e-=1){let t=r[l++];if(128!=(192&t))return null;o=o<<6|63&t}}e+=String.fromCharCode(o)}return e}
Security=(()=>{var n=null,e=null,t=null;async function r(n,e,t){let r=window.atob(n),a=str2ab(r);return window.crypto.subtle.importKey("spki",a,e,!0,[t])}const a={isActive:function(){return null!==n&&null!==e},init:function(a){return async function(a){console.log("Security Initializing..."),n=await r(a.keyEnc,{name:"RSA-OAEP",hash:"SHA-256"},"encrypt"),e=await async function(){return window.crypto.subtle.generateKey({name:"AES-CTR",length:128},!0,["encrypt","decrypt"])}(),t=await async function(n){let e=await window.crypto.subtle.exportKey("raw",n);return new Uint8Array(e)}(e);let i=await r(a.keyVer,{name:"ECDSA",namedCurve:"P-384"},"verify");if(!await async function(n,e,t){let r=str2ab(atob(e)),a=(new TextEncoder).encode(t);return window.crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-384"}},n,r,a)}(i,a.signature,function(n){return[n.challenge||"",n.keyEnc||"",n.keyVer||""].join("")}(a||{})))throw new Error("Signature invalid");console.log("Security Initialized!")}(a)},encrypt:function(r){return async function(r){let a=function(n){let e=new Uint8Array(16);return window.crypto.getRandomValues(e),e}(),i=new Uint8Array(a.length+t.length);i.set(a),i.set(t,a.length);let c=await async function(e){let t=e;return"string"==typeof e&&(t=(new TextEncoder).encode(e)),window.crypto.subtle.encrypt("RSA-OAEP",n,t)}(i),o=await async function(n,e,t){let r=(new TextEncoder).encode(t),a={name:"AES-CTR",counter:e,length:128};return window.crypto.subtle.encrypt(a,n,r)}(e,a,r);return{d:buf2hex(o),k:buf2hex(c)}}(r)},decrypt:function(n){return async function(n){let t=n.iv,r=n.d,a=await async function(n,e,t){let r=hex2ab(t),a=hex2ab(e),i=new Uint8Array(a),c=new Uint8Array(r),o={name:"AES-CTR",counter:i,length:128};return window.crypto.subtle.decrypt(o,n,c)}(e,t,r);var i=stringFromUTF8Array(new Uint8Array(a)),c=JSON.parse(i);return"ws"==c.type&&"data"===c.cmd&&(c=c.data),c}(n)}};return Object.freeze(a),a})();
Generator=(()=>{function e(e){var r,a,i,c=null;a=e.namespace,i=null,a.split(".").every((function(e){return i?(i[e]||(i[e]={}),Object.freeze(i),i=i[e]):(window[e]||(window[e]={}),i=window[e]),!0})),(c=i)[e.action]||(c[e.action]={}),r=c[e.action],e.methods.every((function(a){return function(e,r,a,i){let c={n:e,c:r,m:i.name,l:i.len};var o;a[i.name]=(o=c,function(){let e,r,a=null;return e=Array.prototype.slice.call(arguments),r={namespace:o.n,action:o.c,method:o.m,data:e},a=new Promise((function(e,a){t.emit("call",r,(function(t,r){n(t,r,o,e,a)}))})),a}),Object.freeze(a[i.name])}(e.namespace,e.action,r,a),!0}))}function n(e,n,t,r,a){e?a(e):t.c===n.action&&t.m===n.method&&n.result&&n.result.success?r(n.result):a(n.result||n)}var t={build:function(n){return async function(n){let t=location.pathname.split("/")[1],r=n||location.origin+`/${t}/api`,a=Date.now(),i=await fetch(r,{method:"get",headers:{"x-time":a}}),c=await i.json();var o;return c.challenge=a.toString(),o=c.api,Array.isArray(o)?o.every((function(n){return e(n),!0})):e(o),c}(n)}};return Emitter(t),Object.freeze(t),t})();
WebChannel=(()=>{const t="application/json",n={Accept:t,"Content-Type":t};var e={init:function(t){return function(t){Generator.on("call",(function(e,r){(async function(t,e){let r=Array.isArray(e.data)&&e.data.length>0,a=e;if(Security.isActive()&&r&&(a=await Security.encrypt(JSON.stringify(e))),a=await async function(t,e){let r=JSON.stringify(e),a={method:"post",heaedrs:n,body:r},c=await fetch(t,a);return await c.json()}(t,a),"err"==a.cmd)throw new Error(a.result.msg);return"enc"===a.cmd&&(a=await Security.decrypt(a)),a})(t,e).then(t=>{r(null,t)}).catch(t=>{r(t,null)})}))}(t)}};return Object.freeze(e),e})();
SocketChannel=(()=>{var n=0,t={up:0,down:0},r=null;function e(n){let t=null;try{"string"==typeof n&&(t=JSON.parse(n)),t?async function(n){let t=null;if("err"===n.cmd)return Generator.emit("error",n.result);"data"===n.cmd&&i(n=n.data),"enc"===n.cmd&&(t=await Security.decrypt(n),t&&i(t))}(t):Generator.emit("error",event)}catch(n){Generator.emit("error",n)}}function i(n){Array.isArray(n)?n.every((function(n){return o(n),!0})):o(n)}function o(n){if(t.down++,"function"==typeof t[n.tid])try{t[n.tid](null,n)}finally{t[n.tid]=null}t.up>50&&t.down>=t.up&&(t={up:0,down:0})}function u(e,i){(async function(e,i){let o=null,u=null,a=function(n){let t=Array.isArray(n.data)&&n.data.length>0;return Security.isActive()&&t}(e);!function(r,e){n++,r.tid=n.toString(),t[r.tid]=e,t.up++}(e,i),a?(o=await Security.encrypt(JSON.stringify(e.data)),e.data=[o],u={cmd:"enc",type:"ws",data:[e]}):u={cmd:"data",type:"ws",data:[e]},r.send(JSON.stringify(u))})(e,i).catch(n=>{i(n,null)})}function a(){null!==r&&(r.close(),r=null)}var c={init:function(n){return function(n){return a(),new Promise((function(t,i){return function(n,t,i){(r=new WebSocket(n,["ws4is"])).onopen=function(n){Generator.on("call",u),t(!0)},r.onclose=function(n){Generator.off("call",u),r=null},r.onerror=function(n){Generator.off("call",u),i(n),Generator.emit("error",n),r=null},r.onmessage=function(n){e(n.data)}}(n,t,i)}))}(n)},kill:function(){return a()}};return Object.freeze(c),c})();
Engine=(()=>{var e={init:function(e){return async function(e){Generator.off("call"),SocketChannel&&SocketChannel.kill(),e=e||{};let i=await Generator.build(e.api);if(i.signature&&(Security.isActive()||await Security.init(i)),e.service){if(0===e.service.indexOf("http"))return await WebChannel.init(e.service),!0;if(0===e.service.indexOf("ws"))return await SocketChannel.init(e.service),!0}throw new Error("Invalid definition for Engine Remote Service")}(e)}};return Emitter(e),Object.freeze(e),e})();