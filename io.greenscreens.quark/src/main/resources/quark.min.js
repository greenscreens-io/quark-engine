function Emitter(t){if(t)return mixin(t)}function mixin(t){for(let e in Emitter.prototype)t[e]=Emitter.prototype[e];return t._callbacks={},t}"undefined"!=typeof module&&(module.exports=Emitter),Emitter.prototype.on=Emitter.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},Emitter.prototype.once=function(t,e){function i(){this.off(t,i),e.apply(this,arguments)}return i.fn=e,this.on(t,i),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;let i,r=this._callbacks["$"+t];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(let t=0;t<r.length;t++)if(i=r[t],i===e||i.fn===e){r.splice(t,1);break}return 0===r.length&&delete this._callbacks["$"+t],this},Emitter.prototype.emit=function(t){this._callbacks=this._callbacks||{};let e=[].slice.call(arguments,1),i=this._callbacks["$"+t];if(i){i=i.slice(0);for(let t=0,r=i.length;t<r;++t)i[t].apply(this,e)}return this},Emitter.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},Emitter.prototype.hasListeners=function(t){return!!this.listeners(t).length};
function hex2ab(r){let t=[];for(let n=0;n<r.length;n+=2)t.push(parseInt("0x"+r.substr(n,2),16));return t}function str2ab(r){let t=new ArrayBuffer(r.length),n=new Uint8Array(t);for(let t=0,e=r.length;t<e;t++)n[t]=r.charCodeAt(t);return t}function buf2hex(r){return Array.prototype.map.call(new Uint8Array(r),r=>("00"+r.toString(16)).slice(-2)).join("")}function stringFromUTF8Array(r){const t=[1,1,1,1,2,2,3,0];let n=r.length,e="";for(let l=0;l<n;){let o=r[l++];if(128&o){let e=t[o>>3&7];if(!(64&o)||!e||l+e>n)return null;for(o&=63>>e;e>0;e-=1){let t=r[l++];if(128!=(192&t))return null;o=o<<6|63&t}}e+=String.fromCharCode(o)}return e}
Security=(()=>{var n=null,t=null,e=null;const r=new TextEncoder;async function a(n,t,e){let r=window.atob(n),a=str2ab(r);return window.crypto.subtle.importKey("spki",a,t,!0,[e])}const i={isActive:function(){return null!==n&&null!==t},init:function(i){return async function(i){console.log("Security Initializing..."),n=await a(i.keyEnc,{name:"RSA-OAEP",hash:"SHA-256"},"encrypt"),t=await async function(){return window.crypto.subtle.generateKey({name:"AES-CTR",length:128},!0,["encrypt","decrypt"])}(),e=await async function(n){let t=await window.crypto.subtle.exportKey("raw",n);return new Uint8Array(t)}(t);let c=await a(i.keyVer,{name:"ECDSA",namedCurve:"P-384"},"verify");if(!await async function(n,t,e){let a=str2ab(atob(t)),i=r.encode(e);return window.crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-384"}},n,a,i)}(c,i.signature,function(n){return[n.challenge||"",n.keyEnc||"",n.keyVer||""].join("")}(i||{})))throw n=null,t=null,e=null,new Error("Signature invalid");console.log("Security Initialized!")}(i)},encrypt:function(a,i){return async function(a,i){let c=function(n){let t=new Uint8Array(16);return window.crypto.getRandomValues(t),t}(),u=new Uint8Array(c.length+e.length);u.set(c),u.set(e,c.length);let o=await async function(t){let e=t;return"string"==typeof t&&(e=r.encode(t)),window.crypto.subtle.encrypt("RSA-OAEP",n,e)}(u),l=await async function(n,t,e){let a=r.encode(e),i={name:"AES-CTR",counter:t,length:128};return window.crypto.subtle.encrypt(i,n,a)}(t,c,a);return!0===i?{d:l,k:o}:{d:buf2hex(l),k:buf2hex(o)}}(a,i)},decrypt:function(n){return async function(n){let e=n.iv,r=n.d,a=await async function(n,t,e){let r=hex2ab(e),a=hex2ab(t),i=new Uint8Array(a),c=new Uint8Array(r),u={name:"AES-CTR",counter:i,length:128};return window.crypto.subtle.decrypt(u,n,c)}(t,e,r);var i=stringFromUTF8Array(new Uint8Array(a)),c=JSON.parse(i);return"ws"==c.type&&"data"===c.cmd&&(c=c.data),c}(n)}};return Object.freeze(i),i})();
Generator=(()=>{function e(e){var r,a,c,i=null;a=e.namespace,c=null,a.split(".").every(e=>(c?(c[e]||(c[e]={}),Object.freeze(c),c=c[e]):(window[e]||(window[e]={}),c=window[e]),!0)),(i=c)[e.action]||(i[e.action]={}),r=i[e.action],e.methods.every(a=>(function(e,r,a,c){let i=!1!==c.encrypt,l={n:e,c:r,m:c.name,l:c.len,e:i};var o;a[c.name]=(o=l,function(){let e,r,a=null;return e=Array.prototype.slice.call(arguments),r={namespace:o.n,action:o.c,method:o.m,e:o.e,data:e},a=new Promise((e,a)=>{t.emit("call",r,(t,r)=>{n(t,r,o,e,a)})}),a}),Object.freeze(a[c.name])}(e.namespace,e.action,r,a),!0))}function n(e,n,t,r,a){e?a(e):t.c===n.action&&t.m===n.method&&n.result&&n.result.success?r(n.result):a(n.result||n)}var t={build:function(n){return async function(n){let t=n.api||n;var r;return r=t,Array.isArray(r)?r.every(n=>(e(n),!0)):e(r),t}(n)}};return Emitter(t),Object.freeze(t),t})();
WebChannel=(()=>{const t="application/json",n={Accept:t,"Content-Type":t};var e={init:function(t){return function(t){Generator.off("call"),Generator.on("call",async(e,r)=>{try{r(null,await async function(t,e){let r=Array.isArray(e.data)&&e.data.length>0,a=e;if(Security.isActive()&&r&&(a=await Security.encrypt(JSON.stringify(e))),a=await async function(t,e){let r=JSON.stringify(e),a={method:"post",heaedrs:n,body:r},c=await fetch(t,a);return await c.json()}(t,a),"err"==a.cmd)throw new Error(a.result.msg);return"enc"===a.cmd&&(a=await Security.decrypt(a)),a}(t,e))}catch(t){r(t,null)}})}(t)}};return Object.freeze(e),e})();
SocketChannel=(()=>{const n=new TextDecoder,e=new TextEncoder,t=wasm_bindgen||null;var r=!1,a=0,i={up:0,down:0},o=null;function l(e){let r=null;try{if(e instanceof ArrayBuffer){let a=t.gzip_decode_raw(new Uint8Array(e)),i=n.decode(a);r=JSON.parse(i)}"string"==typeof e&&(r=JSON.parse(e)),r?async function(n){let e=null;"api"===n.cmd?Generator.emit("api",n.data):"err"===n.cmd?Generator.emit("error",n.result):("data"===n.cmd&&c(n=n.data),"enc"===n.cmd&&(e=await Security.decrypt(n),e&&c(e)))}(r):Generator.emit("error",event)}catch(n){Generator.emit("error",n)}}function c(n){Array.isArray(n)?n.every(n=>(u(n),!0)):u(n)}function u(n){if(i.down++,"function"==typeof i[n.tid])try{i[n.tid](null,n)}finally{i[n.tid]=null}i.up>50&&i.down>=i.up&&(i={up:0,down:0})}function f(n,l){(async function(n,l){let c=null,u=null,f=null,d="data",s=function(n){let e=Array.isArray(n.data)&&n.data.length>0&&!1!==n.e;return Security.isActive()&&e}(n);if(function(n,e){a++,n.tid=a.toString(),i[n.tid]=e,i.up++}(n,l),s&&(u=await Security.encrypt(JSON.stringify(n.data)),n.data=[u],d="enc"),f={cmd:d,type:"ws",data:[n]},c=JSON.stringify(f),!r)return o.send(c);c=t.gzip_encode_raw(e.encode(c)),o.send(c.buffer)})(n,l).catch(n=>{l(n,null)})}function d(){null!==o&&(o.close(),o=null)}var s={init:function(n,e){return function(n,e){return d(),new Promise((a,i)=>(async function(n,e,a,i){if(null!==t&&!r)try{e=e||"lib/wasm_flate_bg.wasm";let n=await t(e);r=null!=n}catch(n){r=!1}(o=new WebSocket(n,["ws4is"])).binaryType="arraybuffer",o.onopen=function(n){Generator.on("call",f),a(!0)},o.onclose=function(n){Generator.off("call",f),o=null},o.onerror=function(n){Generator.off("call",f),i(n),Generator.emit("error",n),o=null},o.onmessage=function(n){l(n.data)}}(n,e,a,i),null))}(n,e)},kill:function(){return d()}};return Object.freeze(s),s})();
Engine=(()=>{async function e(e){e.signature&&(Security.isActive()||await Security.init(e)),Generator.build(e.api)}var n={init:function(n){return async function(n){if(!(n=n||{}).api)throw new Error("API Url not defined!");if(Generator.off("call"),SocketChannel&&SocketChannel.kill(),n.api===n.service&&0==n.api.indexOf("ws"))return await function(n){return new Promise((i,t)=>{var a=Date.now();return Generator.once("api",async n=>{n.challenge=a;try{await e(n),i(!0)}catch(e){t(e)}}),SocketChannel.init(n.service+"?q="+a),null})}(n);if(await async function(n){let i=await async function(e){let n=location.pathname.split("/")[1],i=e||location.origin+`/${n}/api`,t=Date.now(),a=await fetch(i,{method:"get",headers:{"x-time":t}}),r=await a.json();return r.challenge=t.toString(),r}(n.api);await e(i)}(n),await async function(e){return!!e.service&&(0===e.service.indexOf("http")?(await WebChannel.init(e.service),!0):0===e.service.indexOf("ws")&&(await SocketChannel.init(e.service),!0))}(n))return!0;throw new Error("Invalid definition for Engine Remote Service")}(n)}};return Emitter(n),Object.freeze(n),n})();